name: Auto Sync Files

on:
  schedule:
    # Run every minute
    - cron: '* * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0 # Fetch full history for proper git operations
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
    
    
    
    - name: Install dependencies and link CLI
      run: |
        pnpm install
        pnpm run link-all
    
    - name: Configure Git
      run: |
        git config --global user.name "VegaShare Bot"
        git config --global user.email "vegashare-bot@noreply.github.com"
    
    - name: Run auto sync
      env:
        SYNC_TIMEOUT_SECONDS: ${{ vars.SYNC_TIMEOUT_SECONDS || '18000' }}
      run: |
        # Use the globally linked vega-cli command
        echo "üîÑ Starting auto sync with timeout: ${SYNC_TIMEOUT_SECONDS} seconds"
        echo "üìç Current working directory: $(pwd)"
        echo "üìÇ Repository root contents:"
        ls -la || echo "‚ùå Cannot list directory"
        
        # Ensure we're in the repository root and use absolute path
        REPO_ROOT=$(pwd)
        VEGA_OUTPUT_PATH="${REPO_ROOT}/vega"
        echo "üéØ Using absolute path for vega output: ${VEGA_OUTPUT_PATH}"
        
        vega-cli check-update --extract --output "${VEGA_OUTPUT_PATH}" --url "https://vegaftp.free.nf/?i=1&seconds=${SYNC_TIMEOUT_SECONDS}"
        
        # Debug: Check where vega folder was created
        echo "üìç After extraction - Current working directory: $(pwd)"
        echo "üìÅ Contents of current directory:"
        ls -la || echo "‚ùå Cannot list directory"
        
        # Debug: List extracted files using absolute path
        echo "üìÅ Contents of vega directory (${VEGA_OUTPUT_PATH}):"
        ls -la "${VEGA_OUTPUT_PATH}/" || echo "‚ùå vega directory not found at ${VEGA_OUTPUT_PATH}"
        
        # Debug: Check if vega folder exists in different locations
        echo "üîç Searching for vega folder in repository:"
        find . -name "vega" -type d 2>/dev/null || echo "‚ùå No vega directory found"
        
        # Debug: Check if vega folder is in cli directory
        echo "üîç Checking cli directory for vega folder:"
        ls -la cli/ 2>/dev/null || echo "‚ùå No cli directory found"
        find cli/ -name "vega" -type d 2>/dev/null || echo "‚ùå No vega directory in cli"
        
        # Debug: Show absolute path of vega folder
        echo "üìç Absolute path of vega folder:"
        echo "${VEGA_OUTPUT_PATH}"
        realpath "${VEGA_OUTPUT_PATH}" 2>/dev/null || echo "‚ùå Cannot resolve vega path"
        
        # Debug: Check if files exist in expected locations
        echo "üîç Checking for specific files in vega directory:"
        find "${VEGA_OUTPUT_PATH}" -name "*.veg" -o -name "*.ini" -o -name "*.pgn" | head -10 || echo "‚ùå No .veg/.ini/.pgn files found"
        
        # Debug: Show git status before any operations
        echo "üìä Git status before processing:"
        git status --porcelain || echo "‚ùå Git status failed"
    
    - name: Check for changes
      id: check-changes
      run: |
        echo "üîç Checking for git changes..."
        
        # Show detailed git status
        echo "üìä Full git status:"
        git status --porcelain || echo "‚ùå Git status failed"
        
        # Show untracked files
        echo "üìÅ Untracked files:"
        git ls-files --others --exclude-standard || echo "‚ùå No untracked files"
        
        # Show modified files
        echo "üìù Modified files:"
        git diff --name-only || echo "‚ùå No modified files"
        
        # Check if there are any changes
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚úÖ Changes detected"
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "‚ÑπÔ∏è No changes detected"
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git add .
        git commit -m "Auto-sync: Update files from remote server
        
        - Synced files changed in the last 5 minutes
        - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - Workflow: ${{ github.workflow }}
        - Run ID: ${{ github.run_id }}"
        git push origin main
    
    - name: Trigger HTML Sync
      if: steps.check-changes.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('üöÄ Triggering HTML sync workflow after auto-sync...');
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'sync-html.yml',
            ref: context.ref
          });
          console.log('‚úÖ HTML sync workflow triggered successfully');
    
    - name: Log completion
      run: |
        if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
          echo "‚úÖ Files synced and committed successfully"
        else
          echo "‚ÑπÔ∏è No changes detected, skipping commit"
        fi
